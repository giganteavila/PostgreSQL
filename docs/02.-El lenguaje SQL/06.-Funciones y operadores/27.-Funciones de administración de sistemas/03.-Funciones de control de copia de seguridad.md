Las funciones que se muestran en la [Tabla 9.91](https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-BACKUP-TABLE) ayudan a realizar copias de seguridad en línea. Estas funciones no pueden ejecutarse durante la recuperación (excepto `pg_backup_start`, `pg_backup_stop`, y `pg_wal_lsn_diff`).

Para más detalles sobre el uso adecuado de estas funciones, véase [la sección 26](https://www.postgresql.org/docs/current/continuous-archiving.html).3.

**Cuadro 9.91. Funciones de control de copia de seguridad**

| Función                Descripción                           |
| ------------------------------------------------------------ |
| `pg_create_restore_point`(   *`name`*`text`) . `pg_lsn`                Crea un registro de marcador en el registro de  escritura-ahead que más tarde se puede utilizar como un objetivo de  recuperación, y devuelve la ubicación de registro de escritura  correspondiente. El nombre de la péntrica se puede utilizar con [recovery-target-name](https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-RECOVERY-TARGET-NAME) para especificar el punto hasta el cual procederá la recuperación.  Evite crear varios puntos de restauración con el mismo nombre, ya que la recuperación se detendrá en el primero cuyo nombre coincidía con el  objetivo de recuperación.                Esta función se limita a los superusuarios por defecto, pero otros usuarios pueden recibir EXECUTE para ejecutar la función. |
| `pg_current_wal_flush_lsn`() `pg_lsn`                Devuelve la ubicación actual de la descarga de registro de escritura (ver notas más abajo). |
| `pg_current_wal_insert_lsn`() `pg_lsn`                Devuelve la ubicación de inserción de registro de escritura actual (ver notas más abajo). |
| `pg_current_wal_lsn`() `pg_lsn`                Devuelve la ubicación de escritura de registro de escritura actual (ver notas más abajo). |
| `pg_backup_start`(   *`label`*`text`[,   *`fast`*`boolean`] . `pg_lsn`                Prepara el servidor para iniciar una copia de  seguridad en línea. El único parámetro requerido es una etiqueta  arbitraria definida por el usuario para la copia de seguridad.  (Típicamente este sería el nombre bajo el cual se almacenará el archivo  de volteo de copia de seguridad.) Si se da el segundo parámetro opcional como `true`, especifica la ejecución  `pg_backup_start`lo más rápido posible. Esto obliga a un puesto de control inmediato que  causará un aumento en las operaciones de E/S, ralentizado cualquier  consulta de ejecución simultánea.                Esta función se limita a los superusuarios por defecto, pero otros usuarios pueden recibir EXECUTE para ejecutar la función. |
| `pg_backup_stop`( [  *`wait_for_archive`*`boolean`] .  `record`(  *`lsn`*`pg_lsn`,  *`labelfile`*`text`,   *`spcmapfile`*`text`)                Termina con una copia de seguridad en línea. El  contenido deseado del archivo de la etiqueta de copia de seguridad y el  archivo de mapa de tablespace se devuelven como parte del resultado de  la función y deben ser escritos a los archivos en el área de copia de  seguridad. Estos archivos no deben ser escritos al directorio de datos  en vivo (lo hará que PostgreSQL no se reinicie en caso de accidente).                Hay un parámetro opcional de tipo `boolean`. Si es falsa, la función volverá inmediatamente después de que se  complete la copia de seguridad, sin esperar a que WAL sea archivado.  Este comportamiento sólo es útil con software de copia de seguridad que  monitorea independientemente el archivo WAL. De lo contrario, WAL  requerido para hacer que la copia de seguridad sea consistente podría  faltar y hacer que la copia de seguridad sea inútil. De forma  predeterminada o cuando este parámetro es verdadero,  `pg_backup_stop`esperará a que WAL se archive cuando esté habilitado el archivo. (En espera, esto significa que esperará sólo cuando  `archive_mode`= `always`. Si escribir actividad en la primaria es bajo, puede ser útil ejecutar  `pg_switch_wal`en la primaria con el fin de activar un interruptor de segmento inmediato.)                Cuando se ejecuta en una primaria, esta función  también crea un archivo de historial de copia de seguridad en el área de archivo de registro de escritura. El archivo de antecedentes incluye la etiqueta dada `pg_backup_start`, los lugares de registro de escritura y final para la copia de  seguridad, y los tiempos de inicio y final de la copia de seguridad.  Después de registrar la ubicación final, el actual punto de inserción de registro de escritura se adelanta automáticamente al siguiente archivo  de registro de escritura, de modo que el archivo de registro de entrada  de escritura final puede archivarse inmediatamente para completar la  copia de seguridad.                El resultado de la función es un solo registro. El  *`lsn`*la columna contiene la ubicación de registro de escritura final de la  copia de seguridad (que de nuevo puede ser ignorada). La segunda columna devuelve el contenido del archivo de la etiqueta de copia de seguridad, y la tercera columna devuelve el contenido del archivo mapa de  tablespace. Estos deben almacenarse como parte de la copia de seguridad y se requieren como parte del proceso de restauración.                Esta función se limita a los superusuarios por defecto, pero otros usuarios pueden recibir EXECUTE para ejecutar la función. |
| `pg_switch_wal`() `pg_lsn`                Forza al servidor a cambiar a un nuevo archivo de  registro de escritura, que permite archivar el archivo actual  (suponiendo que esté usando un archivo continuo). El resultado es la  ubicación final de registro de escritura-ahead más 1 dentro del archivo  de registro de escritura-adelante recién completado. Si no ha habido  actividad de registro de escritura desde el último interruptor de  registro de entrada de escritura,  `pg_switch_wal`no hace nada y devuelve la ubicación inicial del archivo de registro de salida de escritor actualmente en uso.                Esta función se limita a los superusuarios por defecto, pero otros usuarios pueden recibir EXECUTE para ejecutar la función. |
| `pg_walfile_name`(   *`lsn`*`pg_lsn`) . `text`                Convierte una ubicación de registro de escritura en el nombre del archivo WAL que sostiene esa ubicación. |
| `pg_walfile_name_offset`(   *`lsn`*`pg_lsn`) .  `record`(  *`file_name`*`text`,   *`file_offset`*`integer`)                Convierte una ubicación de registro de escritura en un nombre de archivo WAL y el byte offset dentro de ese archivo. |
| `pg_split_walfile_name`(   *`file_name`*`text`) .  `record`(  *`segment_number`*`numeric`,   *`timeline_id`*`bigint`)                Extrae el número de secuencia y el identificador de la línea de tiempo de un nombre de archivo WAL. |
| `pg_wal_lsn_diff`(  *`lsn1`*`pg_lsn`,   *`lsn2`*`pg_lsn`) . `numeric`                Calcula la diferencia en bytes ( *`lsn1`*- - *`lsn2`*) entre dos lugares de registro de escritura. Esto se puede utilizar con  `pg_stat_replication`o algunas de las funciones que se muestran en la  para obtener la rezago de replicación. |

 `pg_current_wal_lsn`muestra la ubicación de escritura de registro de escritura actual en el mismo  formato utilizado por las funciones anteriores. Del mismo modo,  `pg_current_wal_insert_lsn`muestra la ubicación de inserción de registro de escritura actual y  `pg_current_wal_flush_lsn`muestra la ubicación actual de descarga de registro de escritura. La ubicación logicalde la inserción es el final  del registro de escritura en cualquier momento, mientras que la  ubicación de escritura es el final de lo que realmente se ha escrito  desde los amortiguadores internos del servidor, y la ubicación de  enjuagar es la última ubicación conocida por estar escrita para el  almacenamiento duradero. La ubicación de escritura es el final de lo que se puede examinar desde fuera del servidor, y es generalmente lo que  desea si está interesado en archivar archivos de registro de escritura  parcialmente completados. Las ubicaciones de inserción y descarga están  disponibles principalmente para propósitos de depuración de servidores.  Todas estas son operaciones de sólo lectura y no requieren permisos de  superusuario.

Puedes usar  `pg_walfile_name_offset`para extraer el nombre de registro de escritura correspondiente y el byte offset de a  `pg_lsn`valor. Por ejemplo:

```
postgres=-SELECT * DESDE pg.walfile.name-offset((pg.backup-stop ()).lsn);
        file.name . file.offset
-----------------------------
 00000001000000000000000D 4039624
(1 fila)
```

Del mismo modo,  `pg_walfile_name`extrae sólo el nombre del archivo de registro de escritura. Cuando la  ubicación de registro de escritura-ahead dada es exactamente en un  límite de registro de escritura-ahead, ambas funciones devuelven el  nombre del archivo de registro de escritura anterior. Este es  generalmente el comportamiento deseado para manejar el comportamiento de archivo de registro de escritura-ahead, ya que el archivo anterior es  el último que actualmente necesita ser archivado.

 `pg_split_walfile_name`es útil para calcular un  LSNde un archivo de desplazamiento de archivo y nombre de archivo WAL, por ejemplo:

```
postgres=o . . . file-name '000000010000000000000100C000AB'
postgres = . . . offset 256
postgres=-SELECT '0/0'::pg.lsn . pd.segment.number * ps.setting:int . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
  DESDE pg.split.walfile.name(:'file.name') pd,
       pg.show.all.settings () ps
  DONDE ps.name = 'wal-segment-size';
      lsn
- A---------------
 C001/AB000100
(1 fila)
```